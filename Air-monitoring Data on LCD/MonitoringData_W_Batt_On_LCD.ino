//This is the example code of display data on provided on on-baord LCD without any other connectivity
//Developed by sbcomponents


#include <Arduino_GFX_Library.h>
#include "PMS.h"
#include <SoftwareSerial.h>
SoftwareSerial pmsaSer(2,0); //14 rx for dubug

PMS pms(Serial);
PMS::DATA data;

#include <Adafruit_Sensor.h>
#include <Adafruit_BME280.h>

#include <Wire.h>
#include <SPI.h>

#define SEALEVELPRESSURE_HPA (1013.25)

Adafruit_BME280 bme; // I2C

#if defined(DISPLAY_DEV_KIT)
Arduino_GFX *gfx = create_default_Arduino_GFX();
#else /* !defined(DISPLAY_DEV_KIT) */

//Arduino_DataBus *bus = create_default_Arduino_DataBus();

Arduino_DataBus *bus = new Arduino_ESP8266SPI(2 /* DC */, 15 /* CS */);
Arduino_GFX *gfx = new Arduino_ST7789(bus, 16 /* RST */, 0 /* rotation */, true /* IPS */,135 /* width */, 240 /* height */,53 /* col offset 1 */, 40 /* row offset 1 */,53 /* col offset 2 */, 40 /* row offset 2 */);
#endif /* !defined(DISPLAY_DEV_KIT) */
/*******************************************************************************
 * End of Arduino_GFX setting
 ******************************************************************************/
int analogInPin  = A0;    // Analog input pin
int sensorValue;          // Analog Output of Sensor
float calibration = 0.25; // Check Battery voltage using multimeter & add/subtract the value
int bat_percentage;

void setup(void)
{
  Serial.begin(9600);   // GPIO1, GPIO3 (TX/RX pin on ESP-12E Development Board)
  Serial1.begin(9600);  // GPIO2 (D4 pin on ESP-12E Development Board)
  Serial.println(F("BME280 test"));
  bool status;
  status = bme.begin(0x76);  

////////////////////////////////////////
  pmsaSer.begin(9600);
  pmsaSer.println("  PMSA003 dust sensor");

    gfx->begin();
    gfx->fillScreen(BLACK);

#ifdef TFT_BL
    pinMode(TFT_BL, OUTPUT);
    digitalWrite(TFT_BL, HIGH);
#endif

    //gfx->setCursor(10, 10);
    //gfx->setTextColor(RED);
    //gfx->println("Hello World!");
    
    gfx->setCursor(5, 50);
    gfx->setTextColor(YELLOW);
    gfx->setTextSize(2);
    gfx->println("Connect PMS");
  
    gfx->setCursor(2, 90);
    gfx->setTextColor(YELLOW);
    gfx->setTextSize(2);
    gfx->println("Jumpire Wire");
  
    gfx->setCursor(2, 130);
    gfx->setTextColor(YELLOW);
    gfx->setTextSize(2);
    gfx->println("To start");
    delay(2000); // 2 seconds
}

void loop()
{
  if (pms.read(data))
  {
    pmsaSer.print("PM 1.0 (ug/m3): ");
    pmsaSer.println(data.PM_AE_UG_1_0);
    //swSer.println(data.PM_AE_UG_1_0);

    pmsaSer.print("PM 2.5 (ug/m3): ");
    pmsaSer.println(data.PM_AE_UG_2_5);
    //swSer.println(data.PM_AE_UG_2_5);

    pmsaSer.print("PM 10.0 (ug/m3): ");
    pmsaSer.println(data.PM_AE_UG_10_0);
    //swSer.println(data.PM_AE_UG_1_0);
    pmsaSer.println();


    gfx->setTextWrap(false);
    gfx->fillScreen(BLACK);
    gfx->setCursor(5, 10);
    gfx->setTextColor(RED);
    gfx->setTextSize(3);
    gfx->println("Air");


    gfx->setTextWrap(false);
    //tft.fillScreen(ST77XX_YELLOW);
    gfx->setCursor(5, 40);
    gfx->setTextColor(RED);
    gfx->setTextSize(3);
    gfx->println("Monitor");

    gfx->setTextWrap(false);
    //tft.fillScreen(ST77XX_YELLOW);
    gfx->setCursor(5, 70);
    gfx->setTextColor(YELLOW);
    gfx->setTextSize(3);
    gfx->println("(ug/m3)");

         
    gfx->setCursor(5, 120);
    gfx->setTextColor(YELLOW);
    gfx->setTextSize(2);
    gfx->println("PM 1 =" + String(data.PM_AE_UG_1_0));
  
  
    gfx->setCursor(5, 150);
    gfx->setTextColor(YELLOW);
    gfx->setTextSize(2);
    gfx->println("PM 2.5 =" + String(data.PM_AE_UG_2_5));
  
  
    gfx->setCursor(5, 180);
    gfx->setTextColor(YELLOW);
    gfx->setTextSize(2);
    gfx->println("PM 10 =" + String(data.PM_AE_UG_10_0));

    delay(5000);
    
    ////////////////////////////////////////////////////////////////////

    gfx->setTextWrap(false);
    gfx->fillScreen(BLACK);
    gfx->setCursor(5, 10);
    gfx->setTextColor(RED);
    gfx->setTextSize(3);
    gfx->println("weather");
  
  
    gfx->setCursor(5, 60);
    gfx->setTextColor(YELLOW);
    gfx->setTextSize(2);
    gfx->println("T=" + String(bme.readTemperature()));
  
  
    gfx->setCursor(5, 90);
    gfx->setTextColor(YELLOW);
    gfx->setTextSize(2);
    gfx->println("P=" + String(bme.readPressure()));
  
  
    gfx->setCursor(5, 120);
    gfx->setTextColor(YELLOW);
    gfx->setTextSize(2);
    gfx->println("H=" + String(bme.readHumidity()));


    gfx->setCursor(5, 150);
    gfx->setTextColor(YELLOW);
    gfx->setTextSize(2);
    gfx->println("Alt=" + String(bme.readAltitude(SEALEVELPRESSURE_HPA)));
    delay(5000);
  }  
    ////////////////////////////////////////////////////////////////////

  sensorValue = analogRead(analogInPin);
  delay(10);
  float voltage = (((sensorValue * 4.2) / 1024.0) - calibration); //multiply by two as voltage divider network is 100K & 100K Resistor
   // float voltage = (((sensorValue * 3.3) / 1024) + calibration) ; //Caliberation for output voltage

 if (voltage >= 2.8){

    gfx->setTextWrap(true);
    gfx->setRotation(false);
    gfx->fillScreen(BLACK);
    gfx->setCursor(0, 10);
    gfx->setTextColor(RED);
    gfx->setTextSize(3);
    gfx->println("BatteryVoltage");

    
    gfx->setTextWrap(false);
    gfx->setCursor(5, 60);
    gfx->setTextColor(RED);
    gfx->setTextSize(3);
    gfx->println(voltage);
  delay(2000);
}

else if (voltage <= 2.8){
   Serial.print("Battery Low! Please Plugin Charger");
    gfx->setTextWrap(true);
    gfx->setRotation(true);
    gfx->fillScreen(BLACK);
    gfx->setCursor(0, 25);
    gfx->setTextColor(RED);
    gfx->setTextSize(3);
    gfx->println("Battery Low! Please Charge");
    delay(2000);
  
}
}
